# このファイルは、GCP Secret Managerから機密情報を安全に読み込み、
# ビルド時にアプリケーションに組み込むためのCloud Buildの設計図です。
# 実行コマンド: gcloud builds submit --config cloudbuild.yaml .
steps:
  # Dockerイメージのビルドステップ
  - name: 'gcr.io/cloud-builders/docker'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        docker build \
          --tag="us-west1-docker.pkg.dev/$PROJECT_ID/my-app-repo/my-app:latest" \
          --build-arg="API_KEY=$$API_KEY_SECRET" \
          --build-arg="FIREBASE_API_KEY=$$FIREBASE_API_KEY_SECRET" \
          --build-arg="FIREBASE_AUTH_DOMAIN=$$FIREBASE_AUTH_DOMAIN_SECRET" \
          --build-arg="FIREBASE_PROJECT_ID=$$FIREBASE_PROJECT_ID_SECRET" \
          --build-arg="FIREBASE_STORAGE_BUCKET=$$FIREBASE_STORAGE_BUCKET_SECRET" \
          --build-arg="FIREBASE_MESSAGING_SENDER_ID=$$FIREBASE_MESSAGING_SENDER_ID_SECRET" \
          --build-arg="FIREBASE_APP_ID=$$FIREBASE_APP_ID_SECRET" \
          --build-arg="ADMIN_EMAIL=$$ADMIN_EMAIL_SECRET" \
          .
    # availableSecretsで定義したシークレットを、このビルドステップで環境変数として利用可能にする
    secretEnv:
      - 'API_KEY_SECRET'
      - 'FIREBASE_API_KEY_SECRET'
      - 'FIREBASE_AUTH_DOMAIN_SECRET'
      - 'FIREBASE_PROJECT_ID_SECRET'
      - 'FIREBASE_STORAGE_BUCKET_SECRET'
      - 'FIREBASE_MESSAGING_SENDER_ID_SECRET'
      - 'FIREBASE_APP_ID_SECRET'
      - 'ADMIN_EMAIL_SECRET'

# ビルドが成功した後に、完成したイメージをArtifact Registryに自動的にプッシュする
images:
  - 'us-west1-docker.pkg.dev/$PROJECT_ID/my-app-repo/my-app:latest'

# このビルドプロセス全体で利用可能にするシークレットを定義
availableSecrets:
  secretManager:
    # 各シークレットのバージョンと、ビルドステップ内で使用する環境変数名をマッピング
    - versionName: projects/$PROJECT_ID/secrets/API_KEY/versions/latest
      env: 'API_KEY_SECRET'
    - versionName: projects/$PROJECT_ID/secrets/FIREBASE_API_KEY/versions/latest
      env: 'FIREBASE_API_KEY_SECRET'
    - versionName: projects/$PROJECT_ID/secrets/FIREBASE_AUTH_DOMAIN/versions/latest
      env: 'FIREBASE_AUTH_DOMAIN_SECRET'
    - versionName: projects/$PROJECT_ID/secrets/FIREBASE_PROJECT_ID/versions/latest
      env: 'FIREBASE_PROJECT_ID_SECRET'
    - versionName: projects/$PROJECT_ID/secrets/FIREBASE_STORAGE_BUCKET/versions/latest
      env: 'FIREBASE_STORAGE_BUCKET_SECRET'
    - versionName: projects/$PROJECT_ID/secrets/FIREBASE_MESSAGING_SENDER_ID/versions/latest
      env: 'FIREBASE_MESSAGING_SENDER_ID_SECRET'
    - versionName: projects/$PROJECT_ID/secrets/FIREBASE_APP_ID/versions/latest
      env: 'FIREBASE_APP_ID_SECRET'
    - versionName: projects/$PROJECT_ID/secrets/ADMIN_EMAIL/versions/latest
      env: 'ADMIN_EMAIL_SECRET'